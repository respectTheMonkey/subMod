name: Update Static Files

on:
  push:
    branches:
      - main  # Or any branch you'd like to trigger this on

permissions:
  contents: write  # Grant write access to contents (for pushing commits)
  
jobs:
  update-static:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Git
      run: |
        git config --global user.name "respectTheMonkey"
        git config --global user.email "smkvr98+dpd@gmail.com"
        git pull
        
    - name: Clone tipitaka.lk repo with sparse-checkout
      run: |
        git clone --filter=blob:none --no-checkout https://github.com/pathnirvana/tipitaka.lk
        cd tipitaka.lk
        git sparse-checkout init --cone
        git sparse-checkout set public/static/text
        git checkout master
        cd ..
        
    - name: Clone sc-data repo with sparse-checkout
      run: |
        git clone --filter=blob:none --no-checkout https://github.com/digitalpalidictionary/sc-data
        cd sc-data
        git sparse-checkout init --cone
        git sparse-checkout set dpd sc_bilara_data/root/pli/ms
        git checkout main
        cd ..
        
    - name: Check and move 'public/static/text' if needed
      run: |
        if [ ! -d "bjt/public/static/text" ]; then
          mkdir -p bjt/public/static/text
        fi
        
        if ! diff -r tipitaka.lk/public/static/text bjt/public/static/text >/dev/null 2>&1; then
          rm -rf bjt/public/static/text
          mv tipitaka.lk/public/static/text bjt/public/static
        fi

    - name: Check and move 'dpd' if needed
      run: |
        if [ ! -d "sc-data/dpd" ]; then
          mkdir -p sc-data/dpd
        fi
        
        if ! diff -r sc-data/dpd sc-data/dpd >/dev/null 2>&1; then
          rm -rf sc-data/dpd
          mv sc-data/dpd sc-data
        fi

    - name: Check and move 'sc_bilara_data/root/pli/ms' if needed
      run: |
        if [ ! -d "sc-data/sc_bilara_data/root/pli/ms" ]; then
          mkdir -p sc-data/sc_bilara_data/root/pli/ms
        fi
        
        if ! diff -r sc-data/sc_bilara_data/root/pli/ms sc-data/sc_bilara_data/root/pli/ms >/dev/null 2>&1; then
          rm -rf sc-data/sc_bilara_data/root/pli/ms
          mv sc-data/sc_bilara_data/root/pli/ms sc-data/sc_bilara_data/root/pli
        fi

    - name: Commit and push changes
      run: |
        git add .
        git commit -m "Update sparse-checkout config with new repos" || echo "No changes to commit"
        git push origin main
