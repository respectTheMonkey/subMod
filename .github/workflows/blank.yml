name: Update Static Files

on:
  push:
    branches:
      - main  # Or any branch you'd like to trigger this on

permissions:
  contents: write  # Grant write access to contents (for pushing commits)
  
jobs:
  update-static:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Git
      run: |
        git config --global user.name "respectTheMonkey"
        git config --global user.email "smkvr98+dpd@gmail.com"
        git pull
        
    - name: Clone tipitaka.lk repo with sparse-checkout
      run: |
        git clone --filter=blob:none --no-checkout https://github.com/pathnirvana/tipitaka.lk
        cd tipitaka.lk
        git sparse-checkout init --cone
        git sparse-checkout set public/static/text
        git checkout master
        cd ..        
    
    - name: Clone sc-data repo with sparse-checkout
      run: |
        git clone --filter=blob:none --no-checkout https://github.com/digitalpalidictionary/sc-data
        cd sc-data
        git sparse-checkout init --cone
        git sparse-checkout set dpd sc_bilara_data/root/pli/ms
        git checkout main
        cd ..
    
    - name: Clone tipitaka-xml repo with sparse-checkout
      run: |
        git clone --filter=blob:none --no-checkout https://github.com/vipassanatech/tipitaka-xml
        cd tipitaka-xml
        git sparse-checkout init --cone
        git sparse-checkout set romn
        git checkout main
        cd ..
        
    - name: Move 'public/static/text' to resources/bjt
      run: |
        if [ ! -d "resources/bjt/public/static/text" ]; then
          mkdir -p resources/bjt/public/static/text
        fi
        
        if ! diff -r tipitaka.lk/public/static/text resources/bjt/public/static/text >/dev/null 2>&1; then
          rm -rf resources/bjt/public/static/text
          mv tipitaka.lk/public/static/text resources/bjt/public/static
        fi

    - name: Move 'dpd' to resources/sc_data
      run: |
        if [ ! -d "resources/sc_data/dpd" ]; then
          mkdir -p resources/sc_data/dpd
        fi
        
        if ! diff -r sc-data/dpd resources/sc_data/dpd >/dev/null 2>&1; then
          rm -rf resources/sc_data/dpd
          mv sc-data/dpd resources/sc_data
        fi

    - name: Move 'sc_bilara_data/root/pli/ms' to resources/sc_data
      run: |
        if [ ! -d "resources/sc_data/sc_bilara_data/root/pli/ms" ]; then
          mkdir -p resources/sc_data/sc_bilara_data/root/pli/ms
        fi
        
        if ! diff -r sc-data/sc_bilara_data/root/pli/ms resources/sc_data/sc_bilara_data/root/pli/ms >/dev/null 2>&1; then
          rm -rf resources/sc_data/sc_bilara_data/root/pli/ms
          mv sc-data/sc_bilara_data/root/pli/ms resources/sc_data/sc_bilara_data/root/pli
        fi

    - name: Move 'romn' to resources/tipitaka_xml
      run: |
        if [ ! -d "resources/tipitaka_xml/romn" ]; then
          mkdir -p resources/tipitaka_xml/romn
        fi
        
        if ! diff -r tipitaka-xml/romn resources/tipitaka_xml/romn >/dev/null 2>&1; then
          rm -rf resources/tipitaka_xml/romn
          mv tipitaka-xml/romn resources/tipitaka_xml
        fi

    - name: Commit and push changes
      run: |
        git add .
        git commit -m "Update sparse-checkout config with new repos" || echo "No changes to commit"
        git push origin main
